# Ansible

## Running the playbooks

### General Raspberry Pi setup

Assumption: A debian-based operating system was flashed on the card,
with standard credentials (pi:raspberry)
and ssh enabled by creating an empty file named `ssh` in the boot partition
after flashing the SD card.

Running `ansible-playbook playbook-rpi.yaml -u pi --ask-pass --ask-vault-pass`
will:
- update the flashed system
- expand the file system
- set up headless login
- set up timezone, locales and keyboard layout
- set up my typical users

### Specific Raspberry Pi setup

Assumption:
[General Raspberry Pi setup](#General Raspberry Pi setup) was run beforehand,
i.e. the user setting up the pi can log in via his credentials.

Running `ansible-playbook playbook-thorin.yaml -K --ask-vault-pass`
will setup thorin (pihole, samba, docker services).

### Development machine

TBD

### Private PC

TBD


## Setup

I strived to have a modular and multi-platform usable ansible setup;
this is what I came up with:

Each **playbook** is modularly made up by roles that combine tasks;
if I want a machien to run `docker`,
I just have to include the `docker` role in the playbook,
e.g.

```yaml
---
- name: Some playbook
  roles:
	- ...
	- docker
	- ...
```

these roles should be host and platform agnostic!
Roles specifically for a certain platform or host will be prepended,
e.g. `thorin-disk` which does the disk setup for the host `thorin`
or `rpi-expand-filesystem`
which expands the filesystem to the entire SD card on *R*aspberry *Pi*s

Each **role** comes with a main.yaml
(e.g. [roles/docker/tasks/main.yaml](roles/docker/tasks/main.yaml))
that usually combines all tasks that are platform agnostic;
e.g. for `docker` setups I like to have the CLI tool `dry` installed,
which is done by a setup script that runs on any *Nix system.
Every task that is platform specific is outsourced to a platform sepcific file,
e.g. to install docker via package manager
one would need to call the appropirate package manager.

These files are imported to `main.yaml` depending on the platform, e.g.

```yaml
---
- import_task: apt.yaml
  when: ansible_facts['os_family']|lower == 'debian'
  
- import_task: pacman.yaml
  when: ansible_facts['os_family']|lower == 'archlinux'
  
- name: Enable and start docker
  service:
	name: docker
	state: started
	enabled: true
...
```
would import [roles/docker/tasks/apt.yaml](roles/docker/tasks/apt.yaml)
when run on a Debian-based machine like Ubuntu or Raspbian
or  [roles/docker/tasks/pacman.yaml](roles/docker/tasks/pacman.yaml)
when run on a Arch-based machine Manjaro or EndeavourOS.


Currently, only Debian and Arch-based distros are tested and supported;
some roles might feature Gentoo-based or macOS-based roles,
however these are deprecated and might need fixing.

Extending these roles to another platform is as simple
as adding a new import line and a file that does the specific installation,
e.g.

```yaml
- name: Install docker and docker-compose via apt
  become: yes
  apt:
	pkg:
	  - docker.io
	  - docker-compose
	state: latest
	update_cache: yes
	cache_valid_time: 3600
```

Any variables and specifics are outsoured into a variable files,
e.g. [roles/docker/vars/main.yaml](roles/docker/vars/main.yaml)
These files contain different things that the tasks might access.

Any secrets are stored in a `vault.yaml`.
Valut files are generated by calling `ansible-vault encrypt <FILE>`
on the file you want to encrypt.
The file gets replaced by the encryption!
If you want to decrypt it, you can use `ansible-vault decrypt <FILE>`
to get the clear text format;
If you want to view it, you can use `ansible-vault view <FILE>`

Ansible uses AES-256 with CBC mode,
which is a tried and proofed symmetric encryption standard,
that does not allow to decryption without knowing the password;
i.e. the only weak point is the password.

If you use a 50+ totaly random string of characters ranging from letters,
numbers, special characters, in upper and lower case,
it is safe to check these files into your git repository,
as brute-force would take too long to crack these.

Just make sure it meets above criteria and is only used for the vault and not
stored in any clear-text digital form on any of your machines, and you are good
to go.
